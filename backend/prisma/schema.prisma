generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model categorias {
  id                   String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  nombre               String                 @unique
  margen_minimo        Decimal?               @db.Decimal(5, 2)
  margen_recomendado   Decimal?               @db.Decimal(5, 2)
  existe               Boolean                @default(true)
  nombre_norm          String                 @unique(map: "categorias_nombre_norm_uniq")
  productos_categorias productos_categorias[]
}

model cierres_caja {
  id                     String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sucursal_id            String     @db.Uuid
  fecha_inicio           DateTime   @db.Timestamptz(6)
  fecha_fin              DateTime?  @db.Timestamptz(6)
  usuario_id             String     @db.Uuid
  total_efectivo         Decimal    @default(0) @db.Decimal(12, 2)
  total_transferencia    Decimal    @default(0) @db.Decimal(12, 2)
  total_tarjeta          Decimal    @default(0) @db.Decimal(12, 2)
  total_general          Decimal    @default(0) @db.Decimal(12, 2)
  creado_en              DateTime   @default(now()) @db.Timestamptz(6)
  monto_apertura         Decimal    @default(0) @db.Decimal(12, 2)
  monto_cierre_reportado Decimal?   @db.Decimal(12, 2)
  diferencia             Decimal?   @db.Decimal(12, 2)
  abierto_at             DateTime   @default(now()) @db.Timestamptz(6)
  cerrado_at             DateTime?  @db.Timestamptz(6)
  sucursales             sucursales @relation(fields: [sucursal_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  usuarios               usuarios   @relation(fields: [usuario_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model clientes {
  id           String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  nombre       String
  nit          String?
  telefono     String?
  redes        String?
  creado_en    DateTime       @default(now()) @db.Timestamptz(6)
  cotizaciones cotizaciones[]
  ventas       ventas[]
}

model compras {
  id                  String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  proveedor_id        String?           @db.Uuid
  sucursal_id         String            @db.Uuid
  usuario_id          String?           @db.Uuid
  fecha_factura       DateTime?         @db.Date
  fecha_ingreso       DateTime          @default(now()) @db.Timestamptz(6)
  num_factura         String?
  guia_dhl            String?
  doc_sat             String?
  moneda              String            @default("GTQ")
  tipo_cambio         Decimal           @default(1) @db.Decimal(12, 4)
  subtotal_mercaderia Decimal           @default(0) @db.Decimal(14, 2)
  descuento_total     Decimal           @default(0) @db.Decimal(14, 2)
  impuesto_compra     Decimal           @default(0) @db.Decimal(14, 2)
  costo_envio         Decimal           @default(0) @db.Decimal(14, 2)
  costo_desaduanaje   Decimal           @default(0) @db.Decimal(14, 2)
  otros_costos        Decimal           @default(0) @db.Decimal(14, 2)
  total_compra        Decimal           @default(0) @db.Decimal(14, 2)
  prorrateada         Boolean           @default(false)
  estado              purchase_status   @default(BORRADOR)
  observaciones       String?
  creado_en           DateTime          @default(now()) @db.Timestamptz(6)
  proveedores         proveedores?      @relation(fields: [proveedor_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  sucursales          sucursales        @relation(fields: [sucursal_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  usuarios            usuarios?         @relation(fields: [usuario_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  compras_detalle     compras_detalle[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model compras_detalle {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  compra_id            String    @db.Uuid
  producto_id          String    @db.Uuid
  cantidad             Decimal   @db.Decimal(14, 3)
  costo_unitario_base  Decimal   @db.Decimal(12, 2)
  costo_unitario_final Decimal?  @db.Decimal(12, 2)
  total_base           Decimal?  @db.Decimal(14, 2)
  total_final          Decimal?  @db.Decimal(14, 2)
  compras              compras   @relation(fields: [compra_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  productos            productos @relation(fields: [producto_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model cotizaciones {
  id                   String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  folio                Int                    @default(autoincrement())
  fecha                DateTime               @default(now()) @db.Timestamptz(6)
  sucursal_id          String                 @db.Uuid
  usuario_id           String                 @db.Uuid
  cliente_id           String?                @db.Uuid
  cliente_nombre       String?
  subtotal             Decimal                @default(0) @db.Decimal(12, 2)
  descuento            Decimal                @default(0) @db.Decimal(12, 2)
  impuestos            Decimal                @default(0) @db.Decimal(12, 2)
  total                Decimal                @default(0) @db.Decimal(12, 2)
  estado               quote_status           @default(BORRADOR)
  observaciones        String?
  creado_en            DateTime               @default(now()) @db.Timestamptz(6)
  clientes             clientes?              @relation(fields: [cliente_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  sucursales           sucursales             @relation(fields: [sucursal_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  usuarios             usuarios               @relation(fields: [usuario_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  cotizaciones_detalle cotizaciones_detalle[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model cotizaciones_detalle {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cotizacion_id   String       @db.Uuid
  producto_id     String?      @db.Uuid
  cantidad        Decimal      @db.Decimal(12, 3)
  precio_unitario Decimal      @db.Decimal(12, 2)
  descuento       Decimal      @default(0) @db.Decimal(12, 2)
  impuesto        Decimal      @default(0) @db.Decimal(12, 2)
  total_linea     Decimal      @db.Decimal(12, 2)
  cotizaciones    cotizaciones @relation(fields: [cotizacion_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  productos       productos?   @relation(fields: [producto_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model dispositivos {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  alias       String?
  sucursal_id String?     @db.Uuid
  activo      Boolean     @default(true)
  creado_en   DateTime    @default(now()) @db.Timestamptz(6)
  sucursales  sucursales? @relation(fields: [sucursal_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ventas      ventas[]
}

model dte_documentos {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  venta_id     String?     @unique @db.Uuid
  tipo         dte_tipo    @default(RECIBO)
  serie        String?
  numero       String?
  sat_uuid     String?
  sat_fecha    DateTime?   @db.Timestamptz(6)
  status       dte_status  @default(PENDIENTE)
  certificador String?
  req_json     Json?
  resp_json    Json?
  xml_url      String?
  pdf_url      String?
  creado_en    DateTime    @default(now()) @db.Timestamptz(6)
  ventas       ventas?     @relation(fields: [venta_id], references: [id], onUpdate: NoAction)
  dte_items    dte_items[]
}

model dte_items {
  id              String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  dte_id          String         @db.Uuid
  producto_id     String?        @db.Uuid
  descripcion     String
  cantidad        Decimal        @db.Decimal(12, 3)
  precio_unitario Decimal        @db.Decimal(12, 2)
  impuesto        Decimal        @db.Decimal(12, 2)
  total_linea     Decimal        @db.Decimal(12, 2)
  dte_documentos  dte_documentos @relation(fields: [dte_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  productos       productos?     @relation(fields: [producto_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model idempotencia {
  idempotency_key String   @id
  entidad         String
  entidad_id      String?  @db.Uuid
  creado_en       DateTime @default(now()) @db.Timestamptz(6)
}

model inventario_existencias {
  producto_id  String      @db.Uuid
  ubicacion_id String      @db.Uuid
  stock        Decimal     @default(0) @db.Decimal(14, 3)
  existe       Boolean     @default(true)
  productos    productos   @relation(fields: [producto_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ubicaciones  ubicaciones @relation(fields: [ubicacion_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@id([producto_id, ubicacion_id])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model inventario_movimientos {
  id                                                                   String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  fecha                                                                DateTime     @default(now()) @db.Timestamptz(6)
  tipo                                                                 move_type
  producto_id                                                          String       @db.Uuid
  ubicacion_origen_id                                                  String?      @db.Uuid
  ubicacion_destino_id                                                 String?      @db.Uuid
  cantidad                                                             Decimal      @db.Decimal(14, 3)
  motivo                                                               String?
  ref_venta_id                                                         String?      @db.Uuid
  usuario_id                                                           String?      @db.Uuid
  costo_unitario                                                       Decimal?     @db.Decimal(12, 2)
  creado_en                                                            DateTime     @default(now()) @db.Timestamptz(6)
  productos                                                            productos    @relation(fields: [producto_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ubicaciones_inventario_movimientos_ubicacion_destino_idToubicaciones ubicaciones? @relation("inventario_movimientos_ubicacion_destino_idToubicaciones", fields: [ubicacion_destino_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ubicaciones_inventario_movimientos_ubicacion_origen_idToubicaciones  ubicaciones? @relation("inventario_movimientos_ubicacion_origen_idToubicaciones", fields: [ubicacion_origen_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  usuarios                                                             usuarios?    @relation(fields: [usuario_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model productos {
  id                     String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sku                    String                   @unique
  codigo_barras          String?                  @unique
  nombre                 String
  precio_venta           Decimal                  @default(0) @db.Decimal(12, 2)
  iva_porcentaje         Decimal                  @default(0) @db.Decimal(5, 2)
  costo_promedio         Decimal                  @default(0) @db.Decimal(12, 2)
  costo_ultimo           Decimal                  @default(0) @db.Decimal(12, 2)
  costo_compra           Decimal                  @default(0) @db.Decimal(12, 2)
  costo_envio            Decimal                  @default(0) @db.Decimal(12, 2)
  costo_impuestos        Decimal                  @default(0) @db.Decimal(12, 2)
  costo_desaduanaje      Decimal                  @default(0) @db.Decimal(12, 2)
  stock_minimo           Decimal                  @default(0) @db.Decimal(12, 3)
  activo                 Boolean                  @default(true)
  archivado              Boolean                  @default(false)
  zero_since             DateTime?                @db.Timestamptz(6)
  creado_en              DateTime                 @default(now()) @db.Timestamptz(6)
  precio_mayorista       Decimal?                 @db.Decimal(12, 2)
  categoria              String?
  compras_detalle        compras_detalle[]
  cotizaciones_detalle   cotizaciones_detalle[]
  dte_items              dte_items[]
  inventario_existencias inventario_existencias[]
  inventario_movimientos inventario_movimientos[]
  productos_categorias   productos_categorias[]
  ventas_detalle         ventas_detalle[]

  @@index([codigo_barras], map: "idx_prod_codigo_barras")
  @@index([nombre(ops: raw("gin_trgm_ops"))], map: "idx_prod_nombre_trgm", type: Gin)
  @@index([sku], map: "idx_prod_sku")
}

model productos_categorias {
  producto_id  String     @db.Uuid
  categoria_id String     @db.Uuid
  categorias   categorias @relation(fields: [categoria_id], references: [id], onUpdate: NoAction)
  productos    productos  @relation(fields: [producto_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([producto_id, categoria_id])
}

model proveedores {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  nombre    String
  nit       String?
  contacto  String?
  telefono  String?
  email     String?
  direccion String?
  notas     String?
  creado_en DateTime  @default(now()) @db.Timestamptz(6)
  compras   compras[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model roles {
  id       String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  nombre   String     @unique
  usuarios usuarios[]
}

model sucursales {
  id           String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  nombre       String
  codigo       String         @unique
  direccion    String?
  telefono     String?
  activo       Boolean        @default(true)
  creado_en    DateTime       @default(now()) @db.Timestamptz(6)
  cierres_caja cierres_caja[]
  compras      compras[]
  cotizaciones cotizaciones[]
  dispositivos dispositivos[]
  ubicaciones  ubicaciones[]
  usuarios     usuarios[]
  ventas       ventas[]
}

model ubicaciones {
  id                                                                              String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sucursal_id                                                                     String                   @db.Uuid
  nombre                                                                          String
  es_vitrina                                                                      Boolean                  @default(false)
  es_bodega                                                                       Boolean                  @default(false)
  inventario_existencias                                                          inventario_existencias[]
  inventario_movimientos_inventario_movimientos_ubicacion_destino_idToubicaciones inventario_movimientos[] @relation("inventario_movimientos_ubicacion_destino_idToubicaciones")
  inventario_movimientos_inventario_movimientos_ubicacion_origen_idToubicaciones  inventario_movimientos[] @relation("inventario_movimientos_ubicacion_origen_idToubicaciones")
  sucursales                                                                      sucursales               @relation(fields: [sucursal_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([sucursal_id, nombre])
}

model usuarios {
  id                     String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  nombre                 String
  email                  String                   @unique
  pass_hash              String
  rol_id                 String                   @db.Uuid
  activo                 Boolean                  @default(true)
  creado_en              DateTime                 @default(now()) @db.Timestamptz(6)
  sucursal_id            String?                  @db.Uuid
  cierres_caja           cierres_caja[]
  compras                compras[]
  cotizaciones           cotizaciones[]
  inventario_movimientos inventario_movimientos[]
  roles                  roles                    @relation(fields: [rol_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  sucursales             sucursales?              @relation(fields: [sucursal_id], references: [id], map: "usuarios_sucursal_fk")
  ventas                 ventas[]

  @@index([sucursal_id])
}

model ventas {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  folio           Int              @default(autoincrement())
  fecha           DateTime         @default(now()) @db.Timestamptz(6)
  sucursal_id     String           @db.Uuid
  usuario_id      String           @db.Uuid
  cliente_id      String?          @db.Uuid
  cliente_nombre  String?
  subtotal        Decimal          @default(0) @db.Decimal(12, 2)
  descuento       Decimal          @default(0) @db.Decimal(12, 2)
  impuestos       Decimal          @default(0) @db.Decimal(12, 2)
  total           Decimal          @default(0) @db.Decimal(12, 2)
  estado          sale_status      @default(CONFIRMADA)
  idempotency_key String?          @unique
  dispositivo_id  String?          @db.Uuid
  creado_en       DateTime         @default(now()) @db.Timestamptz(6)
  dte_documentos  dte_documentos?
  clientes        clientes?        @relation(fields: [cliente_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  dispositivos    dispositivos?    @relation(fields: [dispositivo_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  sucursales      sucursales       @relation(fields: [sucursal_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  usuarios        usuarios         @relation(fields: [usuario_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ventas_detalle  ventas_detalle[]
  ventas_pagos    ventas_pagos[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model ventas_detalle {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  venta_id        String    @db.Uuid
  producto_id     String    @db.Uuid
  cantidad        Decimal   @db.Decimal(12, 3)
  precio_unitario Decimal   @db.Decimal(12, 2)
  descuento       Decimal   @default(0) @db.Decimal(12, 2)
  impuesto        Decimal   @default(0) @db.Decimal(12, 2)
  total_linea     Decimal   @db.Decimal(12, 2)
  productos       productos @relation(fields: [producto_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ventas          ventas    @relation(fields: [venta_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model ventas_pagos {
  id               String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  venta_id         String         @db.Uuid
  metodo           payment_method
  monto            Decimal        @db.Decimal(12, 2)
  card_brand       String?
  card_last4       String?
  auth_code        String?
  processor_txn_id String?
  creado_en        DateTime       @default(now()) @db.Timestamptz(6)
  ventas           ventas         @relation(fields: [venta_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

enum dte_status {
  PENDIENTE
  EMITIDO
  RECHAZADO
  ANULADO
}

enum dte_tipo {
  FACTURA
  RECIBO
}

enum move_type {
  ENTRADA
  SALIDA
  AJUSTE
  VENTA
  TRASPASO
}

enum payment_method {
  EFECTIVO
  TRANSFERENCIA
  TARJETA
}

enum purchase_status {
  BORRADOR
  CONFIRMADA
  ANULADA
}

enum quote_status {
  BORRADOR
  ENVIADA
  ACEPTADA
  RECHAZADA
  VENCIDA
}

enum sale_status {
  PENDIENTE
  CONFIRMADA
  ANULADA
}
